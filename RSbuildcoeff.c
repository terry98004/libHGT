// -------------------------------------------------------------------
// Program last modified January 9, 2026. 
// Copyright (c) 2024-2026 Terrence P. Murphy
// MIT License -- see hgt.h for details.
// -------------------------------------------------------------------

#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <string.h>
#include <stdbool.h>
#include <ctype.h>
#include <mpfr.h>

#include "hgt.h"

extern struct	HGT_INIT	hgt_init;

// holds coefficients in MPFR form; the bracketed values are [5][44]
mpfr_t	coeffMPFR[GABCKE_NUM_Cj_TERMS][GABCKE_COEFF_PER_Cj];

// -------------------------------------------------------------------
// The following table of power series coefficients is used to calculate
// the C0 through C4 terms of the Riemann-Seigel Formula.  This table is 
// an improved version of the Haselgrove table shown in my book and used
// in the remainder.c source code file (no longer linked).  The table is
// from a 1979 Dissertation by Wolfgang Gabcke, University of Gottingen,
// NEUE HERLEITUNG UND EXPLIZITE RESTABSCHATZUNG DER RIEMANN-SIEGEL-FORMEL,
// pages 102-106. 
//
// The table holds it's data in 5 groups (for Co through C4), with 44
// elements in a group, with each element a character array holding 
// a "representation" of a coefficient with 50 decimal places of digits.
// Each string fits in a 64-byte array.
// -------------------------------------------------------------------
const char coeffGabcke[GABCKE_NUM_Cj_TERMS][GABCKE_COEFF_PER_Cj][64]={
	{						
	 "0.38268 34323 65089 77172 84599 84030 39886 67613 44562 48563", // 00
	 "0.43724 04680 77520 44936 02964 67371 33198 70730 41501 04236", // 02
	 "0.13237 65754 80343 52332 40352 67391 51055 54743 22995 55867", // 04
	"-0. 1360 50260 47674 18865 49831 88709 09990 76607 06870 27422", // 06
	"-0. 1356 76219 70103 58088 79156 70583 49920 61860 29596 96188", // 08
	"-0.  162 37253 23144 46528 28546 25294 13364 97256 59201 71817", // 10
	 "0.   29 70535 37333 79690 78312 72833 99515 86690 67933 33345", // 12
	 "0.    7 94330 08795 21469 58801 63902 64879 50144 87309 91526", // 14
	 "0.       4655 61246 14504 50503 70634 02160 34762 31240 41457", // 16
	"-0.      14327 25163 09551 05754 08246 31206 26158 88246 25803", // 18
	"-0.       1035 48471 12312 94607 50074 15677 38403 49888 27246", // 20
	 "0.        123 57927 08386 17380 56125 76262 31253 03165 10118", // 22
	 "0.         17 88108 38579 54904 98566 67814 07069 04566 45456", // 24
	"-0.            33914 14389 92703 59069 40621 89788 44556 15248", // 26
	"-0.            16326 63390 25659 05101 37405 29710 48102 81346", // 28
	"-0.              378 51093 18541 22038 28546 47200 18504 50264", // 30
	 "0.               93 27423 25920 17248 45662 32063 98698 63600", // 32
	 "0.                5 22184 30159 78136 85531 38931 47853 02371", // 34
	"-0.                  33506 73072 74426 37895 15090 35794 73261", // 36
	"-0.                   3412 42652 28117 26494 08098 71045 62059", // 38
	 "0.                     57 51203 34143 23991 60339 50179 51646", // 40
	 "0.                     14 89530 13632 11505 45475 62777 57347", // 42
	 "0.                        12565 37271 70214 16853 30428 17661", // 44
	"-0.                         4721 29525 01434 25668 95398 81367", // 46
	"-0.                          132 69069 36303 96199 92735 41309", // 48
	 "0.                           11 05343 99951 21418 34453 78225", // 50
	 "0.                              54996 46377 52746 55111 40104", // 52
	"-0.                               1823 13765 02318 02628 06411", // 54
	"-0.                                156 89403 73772 08801 46868", // 56
	 "0.                                  1 58396 35088 23801 16107", // 58
	 "0.                                    34346 20725 43720 40220", // 60
	 "0.                                      170 21033 50031 70178", // 62
	"-0.                                       59 95119 30495 78167", // 64
	"-0.                                        1 04876 82754 09445", // 66
	 "0.                                           8422 13517 83493", // 68
	 "0.                                            258 47038 59772", // 70
	"-0.                                              9 34763 93749", // 72
	"-0.                                                45694 19225", // 74
	 "0.                                                  754 55974", // 76
	 "0.                                                   64 61816", // 78
	"-0.                                                      27882", // 80
	"-0.                                                       7609", // 82
	"-0.                                                         38", // 84
	" 0.                                                          8"},// 86
	{
	" 0.02682 51026 28375 34702 99914 03955 66674 96592 70472 43064", // 01
	"-0. 1378 47734 26351 85304 98704 52589 89616 23659 48225 59753",
	"-0. 3849 12504 82235 08222 87364 15363 18936 68960 98807 49451",
	"-0.  987 10662 99062 07647 20121 47046 18854 06928 04214 59667",
	 "0.  331 07597 60858 40433 29090 76951 30069 78028 02091 85612",
	 "0.  146 47808 57795 41508 24977 96561 98311 19780 77545 77229",
	 "0.    1 32079 40624 87696 36751 61447 49443 09678 24291 83541",
	"-0.    5 92274 87018 47141 32322 34995 28189 56840 68029 12492",
	"-0.      59802 42585 37344 85877 10835 07451 58584 19335 89017",
	 "0.       9641 32245 61698 26352 67298 53298 51666 87570 78366",
	 "0.       1833 47337 22714 41176 00167 93657 83221 90807 53603",
	"-0.         44 67087 56271 78335 99560 79422 71505 51934 65747",
	"-0.         27 09635 08217 72743 21692 62839 87091 93725 93160",
	"-0.            77852 88654 31585 10462 94823 08520 96100 06728",
	 "0.            23437 62601 08936 88532 48455 04871 04512 27313",
	 "0.             1583 01727 89987 52164 21622 26426 28742 11967",
	"-0.              121 19941 57372 37912 46646 34473 80175 72576",
	"-0.               14 58378 11611 08307 01758 28548 16989 99317",
	 "0.                  28786 30525 81319 17504 55821 28002 08761",
	 "0.                   8662 86290 21237 24122 52825 28879 33104",
	 "0.                     84 30722 72713 70412 71560 02253 14627",
	"-0.                     36 30807 22309 73462 00173 24618 11033",
	"-0.                      1 16266 98212 83829 67194 13888 62925",
	 "0.                        10975 48671 15275 31815 90183 28340",
	 "0.                          615 73990 20468 42710 38814 70791",
	"-0.                           22 90928 00676 78471 51396 38263",
	"-0.                            2 20328 11748 84879 53437 95983",
	 "0.                               2476 02518 00402 78508 28527",
	 "0.                                595 42772 15583 65780 22727",
	 "0.                                  3 26120 20746 79595 26153",
	"-0.                                  1 26540 35591 04116 22437",
	"-0.                                     2431 28469 65496 98190",
	 "0.                                      213 83011 38754 69537",
	 "0.                                        7 16779 94139 41062",
	"-0.                                          28242 93607 23367",
	"-0.                                           1500 60741 96069",
	 "0.                                             26 87318 94053",
	 "0.                                              2 49041 95008",
	"-0.                                                 1160 53898",
	"-0.                                                  341 37546",
	"-0.                                                    1 82473",
	 "0.                                                      39328",
	 "0.                                                        562",
	"-0.                                                         38"},// 87
	{
	 "0.00518 85428 30293 16849 37845 81519 23095 95659 68684 33791", // 00
	 "0.   30 94658 38806 34746 03345 67436 09587 88236 69500 30795",
	"-0. 1133 59410 78229 37338 21824 35255 88351 34102 49474 89026",
	 "0.  223 30457 41958 14477 20571 25527 58036 81570 98397 99816",
	 "0.  519 66374 08862 33020 51169 26953 06819 18885 15832 10762",
	 "0.   34 39914 40762 08336 69465 59135 79918 09598 41858 90021",
	"-0.   59 10648 42747 05828 21732 25230 30773 95276 58837 56102",
	"-0.   10 22997 25479 35857 45442 78675 22727 78713 39437 47273",
	 "0.    2 08883 92216 99275 54080 73296 17417 54159 31186 30536",
	 "0.      59276 65493 09653 59578 91996 48498 28633 35742 24986",
	"-0.       1642 38383 62436 27597 76903 02847 78378 04961 61213",
	"-0.       1516 11997 00940 68286 17346 05397 18738 16600 81084",
	"-0.         59 07803 69820 66679 62922 79025 39789 62060 71628",
	 "0.         20 91151 48594 78188 97774 55551 89722 58039 58857",
	 "0.          1 78156 49583 29235 10537 99701 87884 74866 56010",
	"-0.            16164 07245 53538 30752 85576 94444 73857 77680",
	"-0.             2380 69624 96667 61570 72107 40380 13584 97816",
	 "0.               53 98265 29554 25949 18182 00414 83368 22987",
	 "0.               19 75014 21969 69515 27330 87335 88451 72519",
	 "0.                  23332 86873 28826 34831 04815 30059 23548",
	"-0.                  11187 51761 00480 80208 20048 38089 71616",
	"-0.                    416 40094 88883 76718 85011 22836 43331",
	 "0.                     44 46081 10929 18830 28903 04350 09287",
	 "0.                      2 85461 14783 63714 45457 33874 26978",
	"-0.                        11913 23143 00378 94304 97184 75053",
	"-0.                         1298 16343 60736 49894 67099 02313",
	 "0.                           16 12376 31780 33262 33877 96587",
	 "0.                            4 38249 75198 87344 05965 52584",
	 "0.                               2718 63895 76555 75913 88204",
	"-0.                               1145 88965 06774 58036 97439",
	"-0.                                 24 41531 81819 27522 97891",
	 "0.                                  2 35056 75086 79043 46067",
	 "0.                                     8669 25899 56212 98718",
	"-0.                                      372 39779 85489 46268",
	"-0.                                       21 64603 32663 21799",
	 "0.                                          42034 57751 93556",
	 "0.                                           4244 05249 48043",
	"-0.                                             21 23139 27539",
	"-0.                                              6 81349 63731",
	"-0.                                                 3954 73207",
	 "0.                                                  912 11999",
	 "0.                                                   14 05333",
	"-0.                                                    1 02240",
	"-0.                                                       2613"},// 86
	{
	 "0.00133 97160 90719 45690 42698 35729 94522 81238 56353 95317", // 01
	"-0.  374 42151 36379 39370 46641 61864 46239 65812 84315 04245",
	 "0.  133 03178 91932 14681 20318 54722 40241 05098 97088 24610",
	 "0.  226 54660 76547 17871 14760 31990 52100 68874 11951 34489",
	"-0.   95 48499 99850 67304 15112 25515 76501 13355 10463 76633",
	"-0.   60 10038 45896 36039 12075 80587 57956 11286 93255 59075",
	 "0.   10 12885 82867 76621 95334 43494 18087 85828 88131 81267",
	 "0.    6 86573 34492 99825 64245 74283 64865 21853 43285 92530",
	"-0.       5985 36679 15385 98159 30593 38532 89474 47603 32543",
	"-0.      33316 59851 23994 71290 43553 66983 83079 31712 85955",
	"-0.       2191 92891 02435 08105 71848 42192 25369 44570 56301",
	 "0.        789 08842 45681 49441 05552 48261 56888 52335 34195",
	 "0.         94 14685 08129 52621 51652 46515 67088 87214 34441",
	"-0.          9 57011 62108 83480 30188 07228 47736 89941 49204",
	"-0.          1 87631 37453 47066 27968 12970 57776 33187 71497",
	 "0.             4437 83767 93233 99327 46470 89849 67982 03943",
	 "0.             2242 67385 05617 35324 84110 68573 06374 39088",
	 "0.               36 27686 86573 52436 89408 25563 79232 00993",
	"-0.               17 63980 95508 21581 60783 11214 98067 40561",
	"-0.                  79607 65246 78677 77572 90345 17927 78777",
	 "0.                   9419 65149 05896 90763 91489 50256 94424",
	 "0.                    713 31038 54569 65782 45566 67924 63721",
	"-0.                     32 89910 58455 46243 21179 66525 84927",
	"-0.                      4 18073 03748 98459 29136 29248 70562",
	 "0.                         5550 54207 16463 33789 78211 64027",
	 "0.                         1787 04419 06260 12385 87176 36353",
	 "0.                           13 31280 39646 56094 28629 73430",
	"-0.                            5 81861 06110 90987 51617 92166",
	"-0.                              14019 03608 85265 55374 36497",
	 "0.                               1464 13202 11626 25414 89978",
	 "0.                                 60 23326 55108 91423 18945",
	"-0.                                  2 80644 72319 11360 74804",
	"-0.                                    18065 06005 59245 48468",
	 "0.                                      377 95083 31934 08111",
	 "0.                                       42 14558 05294 75628",
	"-0.                                          22110 61928 33988",
	"-0.                                           7977 85719 14915",
	"-0.                                             51 34879 81542",
	 "0.                                             12 48640 63022",
	 "0.                                                20921 85069",
	"-0.                                                 1623 63775",
	"-0.                                                   44 84110",
	 "0.                                                    1 73507",
	"0.                                                        7222"},// 87
	{
	 "0.00046 48338 93617 63381 85363 04625 59567 24354 48586 06911", // 00
	"-0.  100 56607 36534 04707 59778 84972 86295 36576 07524 47568",
	 "0.   24 04485 65737 25793 02244 56678 29485 74707 79638 60162",
	 "0.  102 83086 14970 23218 78262 98312 61578 75598 86311 79072",
	"-0.   76 57861 07175 56441 86599 81580 00799 92688 20944 84998",
	"-0.   20 36528 68030 84817 62148 43874 94623 41995 34626 99416",
	 "0.   23 21229 04910 68727 89513 61265 01723 19707 47803 60658",
	 "0.    3 26021 44243 86519 76077 37788 36663 42848 22539 48214",
	"-0.    2 55790 62517 94952 51402 46040 07009 94523 16332 03060",
	"-0.      41074 64438 91574 47539 81958 90466 42973 86565 39030",
	 "0.      11781 11364 03712 93881 30076 99193 24036 74756 38687",
	 "0.       2445 65614 22484 57854 23157 09490 27874 00696 06211",
	"-0.        239 15824 76734 43224 30329 40478 52236 76188 61144",
	"-0.         75 05214 20703 57552 88539 12019 60449 88740 19466",
	 "0.          1 33122 79416 25842 81929 10105 59867 09920 47183",
	 "0.          1 34406 26754 22561 97186 98076 43428 79957 14390",
	 "0.             3513 77004 24304 85928 69350 05579 88954 29774",
	"-0.             1519 15445 33703 91933 57444 24987 63088 97131",
	"-0.               89 15417 68144 70873 05494 78654 49999 29733",
	 "0.               11 19589 11652 28535 77323 21347 49080 58074",
	 "0.                1 05160 13329 91481 49636 67704 81655 19743",
	"-0.                   5178 65527 36466 83661 53813 02984 65863",
	"-0.                    806 58748 61916 56605 15372 90544 25379",
	 "0.                     10 60820 45305 63965 95048 11473 94417",
	 "0.                      4 43368 06742 99408 72779 24815 58327",
	 "0.                         4320 05114 70350 15243 49603 07768",
	"-0.                         1823 03892 29596 89330 54205 22677",
	"-0.                           51 19936 91748 32861 03251 58521",
	 "0.                            5 69501 09195 37824 74735 00907",
	 "0.                              26690 65454 89392 07244 27408",
	"-0.                               1333 26298 64098 15112 18979",
	"-0.                                 96 85109 54821 70732 19219",
	 "0.                                  2 15253 81124 57602 51413",
	 "0.                                    27096 19871 79632 54227",
	"-0.                                      142 20203 56757 83595",
	"-0.                                       60 92794 84017 58935",
	"-0.                                          44916 13060 57492",
	 "0.                                          11225 20689 24698",
	 "0.                                            207 42966 35345",
	"-0.                                             17 03585 64578",
	"-0.                                                51354 56999",
	 "0.                                                 2107 51424",
	 "0.                                                   95 26704",
	"-0.                                                    2 03596"}};// 86




// -------------------------------------------------------------------
// This function is called when we need to compute Hardy Z values.
// Before use, we must initialize (one time) the MPFR variables that 
// will hold the Grabke coefficients, and (for each 't') the MPFR 
// variables holding the powers of AdjP = 1 - (2 * P).
// -------------------------------------------------------------------
int InitCoeffMPFR(int iFloatBits)
{
int		j;

for(j = 0; j < GABCKE_COEFF_PER_Cj; j++)	// init all coefficient slots
	{
	mpfr_inits2 (iFloatBits, coeffMPFR[0][j], coeffMPFR[1][j], 
	coeffMPFR[2][j], coeffMPFR[3][j], coeffMPFR[4][j],  (mpfr_ptr)0);	
	}
BuildCoefficientsMPFR();
return(1);	
}


// -------------------------------------------------------------------
// This function is called by CloseMPFR, which is called after we are 
// done using all MPFR functions.  Close MPFR clears the remaining 
// memory and any cache used by MPFR. 
// -------------------------------------------------------------------
int CloseCoeffMPFR(void)
{
int		j;

for(j = 0; j < GABCKE_COEFF_PER_Cj; j++)	// clear all coefficienbt slots
	{
	mpfr_clears (coeffMPFR[0][j], coeffMPFR[1][j], 
	coeffMPFR[2][j], coeffMPFR[3][j], coeffMPFR[4][j],  (mpfr_ptr)0);	
	}	

return(1);	
}

// -------------------------------------------------------------------
// Here, we step through all of the strings in coeffGabcke. For each
// string we call CoeffStrToMPFR to: (1) convert that string to
// a valid floating point string (add '0' where needed and remove
// spaces where neded), and (2) then return the value obtained from
// a call to mpfr_set_str.  The returned MPFR value is entered in
// the correct "slot" in coeffMPFR.
// -------------------------------------------------------------------
int BuildCoefficientsMPFR(void)
{
int		i, j;
bool	Debug = DebugMode(hgt_init.DebugFlags, PRINT_COEFF);

for(i = 0; i < 5; i++)
	{
	if(Debug) {							
	printf("-------------------- \n");
		}	
	for (j = 0; j < GABCKE_COEFF_PER_Cj; j++)
		{
		CoeffStrToMPFR(&coeffMPFR[i][j], coeffGabcke[i][j]);
		if(Debug) {						
			if(coeffGabcke[i][j][0] == '-') {
			mpfr_printf("%.50Rf \n", coeffMPFR[i][j]);
				}
			else
				{
				mpfr_printf(" %.50Rf \n", coeffMPFR[i][j]);
				}
			}
		}
	}
return(1);	
}

// -------------------------------------------------------------------
// As described in BuildCoefficientsMPFR, we convert the passed 
// string (from coeffGabcke) to MPFR format.
// -------------------------------------------------------------------
int CoeffStrToMPFR(mpfr_t *Result, const char *strCoeff)
{
char	bufCoeff[100];
char 	bufFinal[100];
char 	bufDecimals[100];
char 	*ptrTest 		= bufCoeff;
char 	*ptrFinal 		= bufFinal;
char	*ptrDecimals 	= bufDecimals;
int		numDecimals, needDecimals;

strcpy(bufCoeff, strCoeff);

	// Move the passed string into bufFinal, up to and
	// including the '.' char (known to exist).
do {
	*ptrFinal++ = *ptrTest;
} while (*ptrTest++ != '.');
	// temporarily terminate the bufFinal string
*ptrFinal = 0;

	// Move all actual digits after the decimal point 
	// (i.e., excluding spaces, etc.) into bufDecimals
do {
	if(isdigit(*ptrTest))
		{
		*ptrDecimals++ = *ptrTest;
		}
} while (*ptrTest++ != 0);
	// temporarily terminate the bufDecimals string
*ptrDecimals = 0;

	// Count the number of decimals in the bufDecimals
	// string.  Then calculate the number of leading
	// zeros needed in the decimal places.
numDecimals  = strlen(bufDecimals);
needDecimals = GABCKE_DECIMAL_PLACES - numDecimals;

	// Continue filling out bufFinal, now with the
	// needed zeros in decimal places.
while(needDecimals-- > 0)
	{
	*ptrFinal++ = '0';
	}

	// Now finisl filling out bufFinal by appending
	// the decimals saved in bufDecimals.
strcpy(ptrFinal, bufDecimals);

	// With buf Final now in the form of a floating
	// point with 50 decimal places, we convert to 
	// MPFR and return that value.
mpfr_set_str (*Result, bufFinal, 10, MPFR_RNDN);
return(1);
}
